# FunBarONT Pipeline Docker Image for PipeCraft
# Base: Ubuntu 24.04 with Miniconda and Mamba
# Target: pipecraft/funbaront

FROM ubuntu:24.04

# Set metadata
LABEL maintainer="PipeCraft"
LABEL description="FunBarONT - Oxford Nanopore Technologies fungal barcoding pipeline"
LABEL version="1.0"

# Environment variables
ENV LANG=C.UTF-8 \
    LC_ALL=C.UTF-8 \
    DEBIAN_FRONTEND=noninteractive \
    CONDA_DIR=/opt/conda \
    PATH=/opt/conda/bin:$PATH

# Install system dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    # Build essentials
    build-essential \
    gcc \
    g++ \
    make \
    cmake \
    pkg-config \
    # Development libraries
    libz-dev \
    libbz2-dev \
    liblzma-dev \
    libncurses5-dev \
    libcurl4-openssl-dev \
    libssl-dev \
    libxml2-dev \
    # Utilities
    wget \
    curl \
    git \
    ca-certificates \
    bzip2 \
    unzip \
    tar \
    gzip \
    procps \
    vim-tiny \
    # Java for BLAST+ and Nextflow
    openjdk-21-jre-headless \
    # Perl for some bioinformatics tools
    perl \
    # Python basics (will be replaced by conda)
    python3-minimal \
    # Clean up
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Install Miniconda
RUN wget --quiet https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O /tmp/miniconda.sh \
    && bash /tmp/miniconda.sh -b -p $CONDA_DIR \
    && rm /tmp/miniconda.sh \
    && $CONDA_DIR/bin/conda clean -afy

# Initialize conda for bash
SHELL ["/bin/bash", "-c"]
RUN conda init bash

# Configure conda channels
RUN conda config --add channels defaults \
    && conda config --add channels bioconda \
    && conda config --add channels conda-forge \
    && conda config --add channels nanoporetech \
    && conda config --set channel_priority flexible

# Accept conda Terms of Service
RUN conda config --set allow_conda_downgrades true \
    && echo "yes" | conda tos accept --channel defaults || true \
    && echo "yes" | conda tos accept --override-channels --channel https://repo.anaconda.com/pkgs/main || true \
    && echo "yes" | conda tos accept --override-channels --channel https://repo.anaconda.com/pkgs/r || true

# Install mamba for faster package installation
RUN conda install -y -n base -c conda-forge mamba \
    && conda clean -afy

# Create dedicated environment for FunBarONT (Python 3.10 required for medaka)
RUN mamba create -y -n funbaront python=3.10 pip \
    && conda clean -afy

# Activate environment and install core bioinformatics tools in stages
# Stage 1: Core alignment and consensus tools
RUN source activate funbaront && \
    mamba install -y \
    minimap2 \
    samtools \
    bcftools \
    racon \
    vsearch \
    && conda clean -afy

# Stage 2: Quality control and filtering
RUN source activate funbaront && \
    mamba install -y \
    nanoplot \
    chopper \
    filtlong \
    && conda clean -afy

# Stage 3: Medaka (has specific Python 3.10 requirement)
RUN source activate funbaront && \
    mamba install -y \
    medaka \
    && conda clean -afy

# Stage 4: ITS extraction and BLAST
RUN source activate funbaront && \
    mamba install -y \
    itsx \
    hmmer \
    blast \
    entrez-direct \
    seqkit \
    && conda clean -afy

# Stage 5: Workflow management
RUN source activate funbaront && \
    mamba install -y \
    nextflow \
    openjdk \
    && conda clean -afy

# Stage 6: Python scientific stack
RUN source activate funbaront && \
    mamba install -y \
    numpy \
    pandas \
    scipy \
    biopython \
    pysam \
    && conda clean -afy

# Stage 7: Python utilities and dependencies (excluding cloud storage - pyarrow pulls AWS/Azure libs)
RUN source activate funbaront && \
    mamba install -y \
    openpyxl \
    cffi \
    plotly \
    tqdm \
    && conda clean -afy

# Install additional Python packages via mamba/pip in the environment
RUN source activate funbaront && \
    mamba install -y \
    ont-fast5-api \
    nanoget \
    parasail-python \
    && conda clean -afy

# Install additional pip packages
RUN source activate funbaront && \
    pip install --no-cache-dir \
    progressbar33

# Set environment to activate by default
ENV CONDA_DEFAULT_ENV=funbaront
ENV PATH=$CONDA_DIR/envs/funbaront/bin:$PATH

# Create working directory
WORKDIR /workspace

# Add activation to bash profile
RUN echo "source activate funbaront" >> ~/.bashrc

# Verify installations
RUN source activate funbaront && \
    echo "=== Verifying installations ===" && \
    python --version && \
    pip --version && \
    echo "NanoPlot: $(NanoPlot --version 2>&1 | head -n1)" && \
    echo "chopper: $(chopper --version 2>&1)" && \
    echo "minimap2: $(minimap2 --version 2>&1)" && \
    echo "racon: $(racon --version 2>&1)" && \
    echo "medaka: $(medaka --version 2>&1)" && \
    echo "vsearch: $(vsearch --version 2>&1 | head -n1)" && \
    echo "ITSx: $(ITSx --version 2>&1)" && \
    echo "blastn: $(blastn -version 2>&1 | head -n1)" && \
    echo "nextflow: $(nextflow -version 2>&1 | head -n1)" && \
    echo "samtools: $(samtools --version 2>&1 | head -n1)" && \
    echo "=== All tools installed successfully ==="

# Create a simple entrypoint script
RUN echo '#!/bin/bash' > /entrypoint.sh && \
    echo 'source activate funbaront' >> /entrypoint.sh && \
    echo 'exec "$@"' >> /entrypoint.sh && \
    chmod +x /entrypoint.sh

# Set entrypoint
ENTRYPOINT ["/entrypoint.sh"]

# Default command
CMD ["/bin/bash"]